- 
    name: ansible task
    hosts: all
    become: yes
    tasks:
      - name: install create repo
        yum: 
         name:
          - httpd
          - createrepo        
          - yum-utils
         state: present  
        when: inventory_hostname in groups['local']
      - name: Disable SELinux
        ansible.posix.selinux:
           state: disabled
        when: inventory_hostname in groups['local']

      - name: Make sure a service unit is running
        systemd:
          state: started
          name: httpd
        when: inventory_hostname in groups['local']
      - name: Enable service httpd and ensure it is not masked
        systemd:
          name: httpd
          enabled: yes
        when: inventory_hostname in groups['local'] 

      - name: download zabbix
        yum:
           name: zabbix
           state: present
           download_only: true
           download_dir: /var/www/html/zabbix1
        when: inventory_hostname in groups['local']

      - name: create repo
        command: createrepo /var/www/html/zabbix1
        when: inventory_hostname in groups['local']

      - name: add repo to the machines
        yum_repository:
           name: zabbix-local
           description: zabbix repo
           baseurl: http://10.0.2.10:80/zabbix1
           enabled: yes
           gpgcheck: no


      - name: create repo
        command: createrepo /var/www/html/zabbix1
        when: inventory_hostname in groups['local']

      - name: Disable SELinux
        ansible.posix.selinux:
           state: disabled
        when: inventory_hostname in groups['zabbix-server']





      - name: install remi packages
        yum: 
          name:
             -  epel-release
             - http://rpms.remirepo.net/enterprise/remi-release-7.rpm   
        when: inventory_hostname in groups['zabbix-server']


      - name: install php
        yum:
         name:
          - httpd
          - php 
          - php-pear
          - php-cgi      
          - php-common
          - php-mbstring        
          - php-snmp     
          - php-gd      
          - php-pecl-mysql
          - php-xml
          - php-mysql 
          - php-gettext  
          - php-bcmath
         enablerepo: remi-php72
        when: inventory_hostname in groups['zabbix-server']

      - name: Enable service httpd and ensure it is not masked
        systemd:
          name: httpd
          enabled: yes
        when: inventory_hostname in groups['zabbix-server']


      - name: Install zabbix on server machine
        yum:
          name:
            - zabbix
            - zabbix-server-mysql
            - zabbix-web-mysql
          enablerepo: zabbix-local
          state: present
        when: inventory_hostname in groups['zabbix-server']


      - name: add my time zone to php conf
        lineinfile: 
          path: /etc/php.ini
          regexp: ";date.timezone =  "
          line: " date.timezone =  Asia/Jerusalem "
          state: present 
        when: inventory_hostname in groups['zabbix-server']



      - name: restart httpd
        systemd:
          state: restarted
          name: httpd 
        when: inventory_hostname in groups['zabbix-server']

    

      - name: install mariadb
        yum: 
          name: mariadb-server
          enablerepo: remi
        
      - name: start mariadb
        systemd:
          name: mariadb
          enabled: yes
      - name: enable mariadb
        systemd:
          name: mariadb
          enabled: yes

    
 
      - name: Allow HTTP
        ansible.builtin.iptables:
          chain: INPUT
          protocol: tcp
          destination_port: 80
          ctstate: NEW
          jump: ACCEPT
        when: inventory_hostname in groups['zabbix-server']


      - name: Allow HTTPS
        ansible.builtin.iptables:
          chain: INPUT
          protocol: tcp
          destination_port: 443
          ctstate: NEW
          jump: ACCEPT
        when: inventory_hostname in groups['zabbix-server']

      
      - name: Allow HTTPS
        ansible.builtin.iptables:
          chain: INPUT
          protocol: tcp
          destination_port: 10051
          ctstate: NEW
          jump: ACCEPT
        when: inventory_hostname in groups['zabbix-server']



      - name: Allow HTTPS
        ansible.builtin.iptables:
          chain: INPUT
          protocol: tcp
          destination_port: 10050
          ctstate: NEW
          jump: ACCEPT
        when: inventory_hostname in groups['zabbix-server']




      - name: create database 
        mysql_db:
            name: zabbixdb
            state: present
            encoding: utf8
        when: inventory_hostname in groups['zabbix-server']


      - name: create db user
        mysql_user:
           name: zabbix
           password: 12345Hh@
           host: localhost
           priv: '*.*:ALL'
           state: present
        when: inventory_hostname in groups['zabbix-server']



      - name: import schema
        shell: ' zcat /usr/share/doc/zabbix-server-mysql-4.4.10/create.sql.gz | mysql -u zabbix -p12345Hh@ zabbixdb'
        when: inventory_hostname in groups['zabbix-server']



      - name: restart mariadb
        systemd:
            name: mariadb
            state: restarted  


      - name: restart zabbix proxy
        systemd:
            name: zabbix-proxy
            state: restarted
        when: inventory_hostname in groups['zabbix-server']

      - name: enable zabbix proxy
        systemd:
            name: zabbix-proxy
            enabled: yes
        when: inventory_hostname in groups['zabbix-server']

 
     
       
      - name: Install zabbix on client machine
        yum:
          name:
            - zabbix
            - zabbix-agent
          enablerepo: zabbix-local
          state: present
        when: inventory_hostname in groups['zabbix-agent']

        
      - name: add my  time zone to php conf
        lineinfile:
          path: /etc/httpd/conf.d/zabbix.conf
          regexp: "# php_value date.timezone Europe/Riga "
          line: "php_value date.timezone Asia/Jerusalem "
          state: present
        when: inventory_hostname in groups['zabbix-server']


     
      - name: restart httpd
        systemd:
          state: restarted
          name: httpd
        when: inventory_hostname in groups['zabbix-server']


      - name: edit parameters
        lineinfile:
          path:  /etc/zabbix/zabbix_server.conf
          regexp: '^DBHost='
          line: DBHost=localhost 
        when: inventory_hostname in groups['zabbix-server']

      - name: edit parameters
        lineinfile:
          path:  /etc/zabbix/zabbix_server.conf
          regexp: '^DBName='
          line: DBName=zabbixdb
        when: inventory_hostname in groups['zabbix-server']


      - name: edit parameters
        lineinfile:
          path:  /etc/zabbix/zabbix_server.conf
          regexp: '^DBUser='
          line: DBUser=zabbix 
        when: inventory_hostname in groups['zabbix-server']


      - name: edit parameters
        lineinfile:
          path: /etc/zabbix/zabbix_server.conf
          regexp: '^DBPassword='
          line: DBPassword=12345Hh@ 
        when: inventory_hostname in groups['zabbix-server']


      - name: restart zabbix
        systemd:
          state: restarted
          name: zabbix-server.service
        when: inventory_hostname in groups['zabbix-server']


    

      - name: restart httpd
        systemd:
          state: restarted
          name: httpd
        when: inventory_hostname in groups['zabbix-server']

      - name: edit parameters
        lineinfile:
          path: /etc/zabbix/zabbix_agentd.conf
          regexp: "Server=127.0.0.1"
          line: "Server=10.0.2.11"
          state: present
        when: inventory_hostname in groups['zabbix-agent']

      - name: edit parameters
        lineinfile:
          path: /etc/zabbix/zabbix_agentd.conf
          regexp: "ServerActive=127.0.0.1"
          line: "ServerActive=10.0.2.11"
          state: present
        when: inventory_hostname in groups['zabbix-agent']
        
      - name: edit parameters
        lineinfile:
          path: /etc/zabbix/zabbix_agentd.conf
          regexp: "Hostname=Zabbix server"
          line: "Hostname=ancible"
          state: present
        when: inventory_hostname in groups['zabbix-agent']




      - name: restart zabbix agent
        systemd:
          state: restarted
          name: zabbix-agent
        when: inventory_hostname in groups['zabbix-agent']

        
      - name: enable zabbix agent
        systemd:
          state: started
          name: zabbix-agent
        when: inventory_hostname in groups['zabbix-agent']























